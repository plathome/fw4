.. _pd_handler_beacon:

ビーコン送信設定
==============================

| WEB UIの「IoTデータ」→「送受信設定」タブの「ビーコン送信設定」メニューより、ビーコンの送信設定を行うことが出来ます。
| ビーコンの送信を行うためには、WEB UIの「サービス」→「基本」→「BT I/F」タブより、サービス機能の基本設定としBT I/F (hci0)が「使用する」に設定されている必要があります。
| サービス機能の基本設定については、:ref:`webui` の :ref:`webui_service` を参照して下さい。
| 「ビーコン送信設定」メニューが表示されていない場合は、:ref:`data_handler_application` を参照し、PD Handler BLEを「使用する」に設定して下さい。

.. figure:: beacon_init.png
  :scale: 100%

初期状態の送信先設定は上図のようになっています。
ここで、ビーコンデータをクラウド等への送信する場合には、"送信する"を選択します。

.. warning::
   後述のデバイス情報送信設定で送信対象としているビーコンには、本項は適用されません。

.. figure:: beacon.png
  :scale: 100%

「送信する」を選択すると各設定項目が上図のように表示されます。

.. list-table:: ビーコン送信設定の設定項目
    :widths: 30 70
    :header-rows: 1
    
    * - 設定項目
      - 説明
    * - デバイス番号
      - OpenBlocksシリーズのWEB UI内で管理している番号です。変更はできません。
    * - データ間引間隔
      - データを間引くための入力データを受け取らない時間をmsec単位で設定します。　
        0の場合、間引きは行われません。
    * - バッファーサイズ
      - データの最大サイズを設定します。単位はバイトです。
    * - ビーコンソナー機能
      - 受信対象となっているビーコンデータを受信した際にビーコンソナーを有効にするか無効を設定します。 \*1
    * - 制御タイプ
      - ビーコンデータを管理する方式を以下から選択します。　
        各方式については後述の"ビーコン重複制御アルゴリズム"を参照してください。

        1. インターバルトランスファー
        2. エントリーポイントトランスファー
        3. インアウトステータストランスファー
    * - 複制御時間間隔[ms]
      - 各制御タイプにて用いる制御時間をmsec単位で設定します。
    * - ペイロード管理
      - ビーコンデータをPD Repeaterへ渡す際に、ビーコンの各情報を付随させるかを選択します。
      
        data:
            アドバタイズデータ(16進数)
        localname:
            デバイス名
        type:
            データ種別
    * - データフィルタ機能
      - (データプレフィックス) 送信対象のビーコンを選別するフィルタを設定します。　
        データプレフィックスに16進文字列でフィルタ条件を入力すると、
        ビーコンのアドバタイズ情報を前方一致で比較し一致したもののみを送信先へ送信します。

        * 「追加」ボタンにて、複数登録できます。
        * データフィルタを設定する場合には、本装置内(local)内のログのdataを参照しデバイスをフィルタリングしてください。　本装置内のログは(local)内のログについてもフィルタは適用されます。
    * - 受信信号強度閾値フィルタ設定
      - 受信対象とするビーコンの信号強度閾値フィルタを使用するか設定します。
    * - 受信信号強度閾値
      - 受信対象とするビーコンの信号強度を設定します。
    * - 固定情報付与(JSON)
      - データに付加する静的情報をJSON文字列で設定します。
    * - 送信先設定
      - “使用する"を選択した送信先に対してチェックボックスが選択できるようになります。 
        チェックを付けた送信先に対して、送信を行います。　
        チェックをつけると送信先固有の設定項目が表示されます。　
        送信先固有の設定については、:ref:`pd_repeater_device` を参照して下さい。

.. raw:: latex

   \clearpage

.. note::
  1. ビーコンソナー機能を送信対象にした状態においてUSBスピーカー(型番：MM-SPU8BK)を
     接続した状態にて受信対象(データフィルタ及び受信信号強度閾値フィルタについても考慮)となっている
     ビーコンデータを受信した場合には、スピーカーから検出音が鳴ります。

  * C言語版 PD Handler BLE で対応していない非コネクション型BLEセンサーについては、 
    :ref:`data_handler_custum_lua_extention` 機能で対応することが可能です。

.. raw:: latex

   \clearpage

.. raw:: html

   <br><br>

■　ビーコン重複制御アルゴリズム

* この説明における前提となる設定

  * ビーコンの送信間隔 ＝ 1秒
  * 重複制御時間間隔（CHt）＝ 5秒

1. | インターバルトランスファー
   | ビーコンを受信している間は、指定された一定間隔で送信プログラムへ。

.. figure:: interval_transfer.png
  :scale: 100%

2. | エントリーポイントトランスファー
   | （CHt時間内の一時非受信は退場扱いとしない）

.. figure:: entory_point_transfer.png
  :scale: 100%

3. | インアウトステータストランスファー
   | （CHt時間内の一時非受信は退場扱いとしない）

.. figure:: inout_status_transfer.png
  :scale: 100%

.. raw:: latex

   \clearpage
