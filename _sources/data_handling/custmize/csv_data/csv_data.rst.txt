.. _data_handler_custum_csv_data:

*********************
CSVデータ送信機能
*********************

| CSVファイルをJSONデータに変換し、PD RepeaterやNode-REDのUnix Domain Socketに対して書き込みを行うことができます。
| 本機能では、対象のディレクトリにファイルを配置した際に自動で変換し書き込みを行います。尚、一時的に有効にしていない状態でのファイル配置時にも処理が行うよう30分に1度処理を行います。
| WEB UIの「IoTデータ」→「CSV送信」タブから設定可能です。また、本機能はダッシュボードのプロセス状況のIoT制御(IoTデータ)の「起動」、「停止」にも連動しています。
| (ただし、30分に一度の定期実行は連動していません)

■ CSVデータ送信設定

.. figure:: cvs_data_init.png
  :scale: 100%

初期状態では上図のようになっています。

.. raw:: latex

   \clearpage

.. figure:: cvs_data.png
  :scale: 100%

「使用設定」を「有効」にすると上図のように設定項目が表示されます。

.. list-table:: CSVデータ送信設定の設定項目
    :widths: 30 70
    :header-rows: 1
    
    * - 設定項目
      - 説明 
    * - CSVデータ送信機能
      - 本機能の使用設定となります。使用する場合には「使用する」を選択してください。
    * - 入力ディレクトリ
      - 本機能の入力とするCSVファイルのディレクトリの指定です。
    * - 処理済ディレクトリ 
      - 本機能にて処理を行ったCSVファイルの退避先ディレクトリの指定です。
    * - エラーディレクトリ
      - 本機能の処理時にエラーとなったCSVファイルの移動先ディレクトリの指定です。
    * - 処理データ確保日数
      - 処理済ディレクトリに配置したファイルの確保しておく日数の指定です。
    * - エラーデータ確保日数
      - エラーディレクトリに配置したファイルの確保しておく日数の指定です。

| 保存ボタンを押すことに反映されます。
| また、処理データ及びエラーデータは各確保日数経過後に削除されます。そのため、
  自動で削除したくない場合には、確保日数を大きくし定期的にクリーンナップ処理を行ってください。

.. raw:: latex

   \clearpage

■ CSV変換設定

.. figure:: cvs_convert.png
  :scale: 100%

.. list-table:: CSV変換設定の設定項目
    :widths: 30 70
    :header-rows: 1
    
    * - 設定項目
      - 説明 
    * - 変換ルール
      - CSVの変換ルールをユニークに扱うための目ルール名を設定します。
    * - 処理対象ファイルルール
      - 正規表現に処理対象のファイル名を指定します。
    * - 区切り文字
      - 処理対象のファイルの区切り文字を選択します。サポートしているのはカンマ区切りまたはスペース区切りとなります。
    * - JSON書込先
      - CSVをJSONへ変換した際に書き込む先のUnix Domain Socketを指定します。
    * - ソケット種類
      - 書き込み先のUnix Domain SocketがAbstractソケットか通常のUnix Domainソケットかを選択します。
    * - 変換ルール詳細
      - 
    * - + 対象カラム
      - CSVのレコードの何カラム目を取り込むかの指定を行います。
    * - + JSONキー
      - 取り込み対象のカラムに対して設定するJSONキーを指定します。
    * - + 値種類
      - 値の取り込み時に設定するデータの型を指定します。尚、”ISO8601日付フォーマット”は自動変換を行います。変換に失敗した場合は、値は設定されません。
    * - + 未存在時処理
      - 対象カラムが存在しない場合の処理を設定します。尚、空文字設定は値種類が”文字列”の場合に適用されます。
    * - 固定付与データ(JSON)
      - CSVをJSONへ変換した際に固定情報として付与したいデータをJSON形式にて記載します。尚、本項目に設定可能なJSONは第一階層がHash情報となります。
        | Ex.) :

             {"add_info": "sample", "add_value": 1 }

.. warning::
   処理対象ファイルルールの正規表現はPHPにおけるpreg_match関数を適用しています。
   そのため、WEB等にてpreg_matchの正規表現の確認を推奨いたします。
   尚、入力フォーム部に設定する箇所はpreg_match関数の以下の部分となります。 

       preg_match('/<入力フォーム部>/', $filename)

.. raw:: latex

   \clearpage

■ CSV変換ルール一覧

| CSV変換設定の一覧が表示されます。
| 編集ボタンを押すことにより、CSV変換設定のフォームに設定している内容が入力されます。
| また、削除ボタンを押すことにより設定したルールを削除することができます。

.. figure:: cvs_list.png
  :scale: 100%

.. raw:: latex

   \clearpage
