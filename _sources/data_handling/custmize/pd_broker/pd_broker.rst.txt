.. _data_handler_custum_pd_broker:

**************************************
PD Broker
**************************************

PD Brokerは単一のUNIXドメインソケット受けたデータを複数のUNIXドメインソケットに送る、
接続構成をカスタマイズするためのアプリケーションです。

.. figure:: broker_overview.png
  :scale: 65%

例えば、下図のようにPD Handler BLE でビーコンを受け、Node-RED でフィルタリングし、
PD Repeater を介し MQTT 接続でクラウドへデータ送る構成で、
同じ MQTT 接続を用いて制御メッセージを受け取り Node-RED のフィルタリングパラメータと PD Agent を制御しようとする場合等に用いられます。

.. figure:: broker_config.png
  :scale: 65%

WEB UIの「IoTデータ」→「PD Broker」タブからPD Brokerの設定を行うことができます。
| 「PD Broker」タブが表示されていない場合は、:ref:`data_handler_application`  を参照し、PD Brokerを「使用する」に設定して下さい。

.. figure:: pd_broker_init.png
  :scale: 100%

初期状態では上図のようになっています。

| 「使用設定」を「有効」にすると設定項目が表示されます。
| 複数のデバイスに対する設定行う場合は「追加」をクリックし設定フォームを追加します。

.. raw:: latex

   \clearpage

.. figure:: pd_broker.png
  :scale: 100%

「使用設定」を「有効」にすると上図のように設定項目が表示されます。

.. list-table:: PD Broker の設定項目
    :widths: 30 70
    :header-rows: 1
    
    * - 設定項目
      - 説明 
    * - 追加
      - 複数の待受けソケットを設定する場合にクリックします。２個目以降の入力フォームが表示されます。
    * - バッファーサイズ
      - データの最大サイズを設定します。単位はバイトです
    * -
      - 待受けソケット：データを待受るUNIXドメインソケットのパス名を設定します。
        先頭が '@' の場合は抽象的ドメイン名となります。
    * - 書込先設定
      - 「追加」をクリックすると２個目以降の入力フォームが表示されます。
    * - 適応トピックフィルタ
      - 待受けソケットから受け取ったメッセージのヘッダーに指定されたトピックと一致する場合にのみ、
        書込先ソケットにデータを送ります。
        空欄の場合、トピックによるフィルタリングは行われません。
    * - JSONキー
      - 待受けソケットから受け取ったメッセージに指定された JSONキー が含まれている場合にのみ、
        書込先ソケットにデータを送ります。
        空欄の場合、JSON キーによるフィルタリングは行われません。
    * - 書込先ソケット
      - データの送り先となるUNIXドメインソケットのパス名を設定します。先頭が '@' の場合は抽象的ドメイン名となります。

.. raw:: latex

   \clearpage
